<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>客户点餐系统</title>
</head>
<body>
  <h2>菜单</h2>
  <div id="menu"></div>

  <h2>购物车</h2>
  <div id="cart"></div>

  <button onclick="viewCart()">查看购物车</button>
  <button onclick="checkout()">结账</button>

  <script>
    const userId = 1001;     // 客户ID
    const vendorId = 1;      // 商家ID（菜单归属）
    const host = "http://47.88.23.191";

    async function loadMenu() {
        const res = await fetch(`${host}:8089/api/menu/view?userId=${vendorId}`);
        const data = await res.json();
        const menuEl = document.getElementById("menu");
        if (!menuEl) {
            console.error("找不到 menu 元素");
            return;
        }
        if (!data.items || data.items.length === 0) {
            menuEl.innerHTML = "<p>菜单为空</p>";
            return;
        }
        menuEl.innerHTML = data.items.map(item => `
          <div style="margin-bottom:10px;">
            <img src="${item.imageUrl}" width="100"><br>
            <strong>${item.name}</strong><br>
            价格: ¥${item.price}<br>
            <button onclick="addToCart(${item.id}, '${item.name}', '${item.imageUrl}', ${item.price})">加入购物车</button>
          </div>
        `).join("");
    }

    async function addToCart(productId, name, imageUrl, price) {
        await fetch(`${host}:8081/api/cart/add?userId=${userId}&productId=${productId}&name=${encodeURIComponent(name)}&imageUrl=${encodeURIComponent(imageUrl)}&quantity=1&price=${price}`, {
            method: "POST"
        });
        alert("已加入购物车");
    }

    async function viewCart() {
        const res = await fetch(`${host}:8081/api/cart/view?userId=${userId}`);
        const data = await res.json();
        const cartEl = document.getElementById("cart");
        if (!data.items || data.items.length === 0) {
            cartEl.innerHTML = "<p>购物车为空</p>";
            return;
        }
        cartEl.innerHTML = data.items.map(item => `
          <div style="margin-bottom:10px;">
            <img src="${item.imageUrl}" width="80"><br>
            <strong>${item.name}</strong><br>
            数量: ${item.quantity} × ¥${item.price}
          </div>
        `).join("");
    }

    async function checkout() {
        const res = await fetch(`${host}:8082/api/order/checkout?userId=${userId}`, {
            method: "POST"
        });
        const order = await res.json();
        alert("订单创建成功！订单编号: " + order.id);
        viewCart(); // 重新查看购物车（应已清空）
    }

    // 等页面加载完成后再运行 loadMenu
    document.addEventListener("DOMContentLoaded", loadMenu);
  </script>
</body>
</html>
